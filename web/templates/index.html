<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #00d9ff;
        }
        
        .file-input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-input-box {
            flex: 1;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-box:hover {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }
        
        .file-input-box.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .file-input-box input {
            display: none;
        }
        
        .file-input-box .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .file-input-box .label {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .file-input-box .filename {
            font-size: 0.9em;
            color: #00ff88;
            word-break: break-all;
        }
        
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
        }
        
        .param-group label {
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        
        .param-group input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
        }
        
        .param-group input:focus {
            outline: 2px solid #00d9ff;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-center {
            display: flex;
            justify-content: center;
        }
        
        #loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #results {
            display: none;
        }
        
        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .result-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00ff88;
        }
        
        .result-item .label {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .result-item.detected .value {
            color: #00ff88;
        }
        
        .result-item.not-detected .value {
            color: #ff6b6b;
        }
        
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .matches-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .matches-table th,
        .matches-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .matches-table th {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            font-weight: 600;
        }
        
        .matches-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .similarity-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .similarity-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .file-input-group {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="card">
            <h2>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h2>
            <div class="file-input-group">
                <div class="file-input-box" id="original-box" onclick="document.getElementById('original').click()">
                    <input type="file" id="original" accept="audio/*" onchange="handleFileSelect(this, 'original-box')">
                    <div class="icon">ğŸ¼</div>
                    <div class="label">åŸæ›²ãƒ•ã‚¡ã‚¤ãƒ«</div>
                    <div class="filename" id="original-name">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                </div>
                <div class="file-input-box" id="sample-box" onclick="document.getElementById('sample').click()">
                    <input type="file" id="sample" accept="audio/*" onchange="handleFileSelect(this, 'sample-box')">
                    <div class="icon">ğŸ¹</div>
                    <div class="label">ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«</div>
                    <div class="filename" id="sample-name">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>âš™ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h2>
            <div class="params-grid">
                <div class="param-group">
                    <label>æ¤œå‡ºé–¾å€¤</label>
                    <input type="number" id="threshold" value="0.2" step="0.05" min="0" max="1">
                </div>
                <div class="param-group">
                    <label>ãƒ†ãƒ³ãƒå€ç‡ï¼ˆæœ€å°ï¼‰</label>
                    <input type="number" id="tempo_min" value="1.5" step="0.05" min="0.5" max="3">
                </div>
                <div class="param-group">
                    <label>ãƒ†ãƒ³ãƒå€ç‡ï¼ˆæœ€å¤§ï¼‰</label>
                    <input type="number" id="tempo_max" value="2.0" step="0.05" min="0.5" max="3">
                </div>
                <div class="param-group">
                    <label>ãƒ†ãƒ³ãƒåˆ»ã¿</label>
                    <input type="number" id="tempo_step" value="0.05" step="0.01" min="0.01" max="0.5">
                </div>
            </div>
            <div class="btn-center">
                <button class="btn btn-primary" id="detectBtn" onclick="runDetection()">ğŸ” æ¤œå‡ºé–‹å§‹</button>
            </div>
        </div>
        
        <div id="loading" class="card">
            <div class="spinner"></div>
            <p>è§£æä¸­...</p>
        </div>
        
        <div id="results">
            <div class="card">
                <h2>ğŸ“Š æ¤œå‡ºçµæœ</h2>
                <div class="result-summary" id="result-summary"></div>
            </div>
            
            <div class="card">
                <h2>ğŸ“ˆ é¡ä¼¼åº¦æ›²ç·š</h2>
                <div class="chart-container">
                    <canvas id="similarityChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ¯ ãƒãƒƒãƒä¸€è¦§ï¼ˆä¸Šä½20ä»¶ï¼‰</h2>
                <table class="matches-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>æ™‚åˆ»</th>
                            <th>é¡ä¼¼åº¦</th>
                            <th>ãƒ†ãƒ³ãƒ</th>
                            <th>ãƒ”ãƒƒãƒ</th>
                        </tr>
                    </thead>
                    <tbody id="matches-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let chart = null;
        
        function handleFileSelect(input, boxId) {
            const box = document.getElementById(boxId);
            const nameEl = document.getElementById(boxId.replace('-box', '-name'));
            
            if (input.files && input.files[0]) {
                box.classList.add('active');
                nameEl.textContent = input.files[0].name;
            }
        }
        
        async function runDetection() {
            const originalFile = document.getElementById('original').files[0];
            const sampleFile = document.getElementById('sample').files[0];
            
            if (!originalFile || !sampleFile) {
                alert('ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§äº‹å‰è­¦å‘Šï¼‰
            const totalSizeMB = (originalFile.size + sampleFile.size) / (1024 * 1024);
            if (totalSizeMB > 10) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆåˆè¨ˆ${totalSizeMB.toFixed(1)}MBï¼‰ã€‚\n10MBä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚\n\nçŸ­ã„WAVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¬ãƒ¼ãƒˆã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            const formData = new FormData();
            formData.append('original', originalFile);
            formData.append('sample', sampleFile);
            formData.append('threshold', document.getElementById('threshold').value);
            formData.append('tempo_min', document.getElementById('tempo_min').value);
            formData.append('tempo_max', document.getElementById('tempo_max').value);
            formData.append('tempo_step', document.getElementById('tempo_step').value);
            
            // UIæ›´æ–°
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('detectBtn').disabled = true;
            
            try {
                const response = await fetch('/detect', {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type') || '';
                let data = null;

                if (contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    const head = text.slice(0, 300);
                    throw new Error(`ã‚µãƒ¼ãƒãŒJSONã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸ (HTTP ${response.status})\n${head}`);
                }

                if (!response.ok) {
                    let errMsg = data && data.error ? data.error : `HTTP ${response.status}`;
                    if (data && data.detail) {
                        errMsg += '\n\nè©³ç´°:\n' + data.detail;
                    }
                    throw new Error(errMsg);
                }

                if (data.error) {
                    let errMsg = data.error;
                    if (data.detail) {
                        errMsg += '\n\nè©³ç´°:\n' + data.detail;
                    }
                    throw new Error(errMsg);
                }

                displayResults(data);
                
            } catch (error) {
                let msg = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                if (error.detail) {
                    msg += '\n\nè©³ç´°:\n' + error.detail;
                }
                alert(msg);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('detectBtn').disabled = false;
            }
        }
        
        function displayResults(data) {
            // çµæœã‚µãƒãƒªãƒ¼
            const summary = document.getElementById('result-summary');
            const detectedClass = data.detected ? 'detected' : 'not-detected';
            const detectedText = data.detected ? 'æ¤œå‡º' : 'æœªæ¤œå‡º';
            
            summary.innerHTML = `
                <div class="result-item ${detectedClass}">
                    <div class="value">${detectedText}</div>
                    <div class="label">åˆ¤å®šçµæœ</div>
                </div>
                <div class="result-item">
                    <div class="value">${data.matches.length}</div>
                    <div class="label">ãƒãƒƒãƒæ•°</div>
                </div>
                <div class="result-item">
                    <div class="value">${data.best_match ? (data.best_match.similarity * 100).toFixed(2) + '%' : '-'}</div>
                    <div class="label">æœ€é«˜é¡ä¼¼åº¦</div>
                </div>
                <div class="result-item">
                    <div class="value">${data.best_match ? data.best_match.time.toFixed(2) + 's' : '-'}</div>
                    <div class="label">æ¤œå‡ºä½ç½®</div>
                </div>
                <div class="result-item">
                    <div class="value">${data.tempo_ratio.toFixed(2)}x</div>
                    <div class="label">ãƒ†ãƒ³ãƒå€ç‡</div>
                </div>
                <div class="result-item">
                    <div class="value">${data.pitch_shift >= 0 ? '+' : ''}${data.pitch_shift}</div>
                    <div class="label">ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆ</div>
                </div>
            `;
            
            // ã‚°ãƒ©ãƒ•
            drawChart(data.similarity_curve);
            
            // ãƒãƒƒãƒä¸€è¦§
            const tbody = document.getElementById('matches-body');
            tbody.innerHTML = data.matches.map((m, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${m.time.toFixed(2)}s</td>
                    <td>
                        <div>${(m.similarity * 100).toFixed(2)}%</div>
                        <div class="similarity-bar"><div class="fill" style="width: ${m.similarity * 100}%"></div></div>
                    </td>
                    <td>${m.tempo_ratio.toFixed(2)}x</td>
                    <td>${m.pitch_shift >= 0 ? '+' : ''}${m.pitch_shift}</td>
                </tr>
            `).join('');
            
            document.getElementById('results').style.display = 'block';
        }
        
        function drawChart(similarityCurve) {
            const ctx = document.getElementById('similarityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’é–“å¼•ãï¼ˆè¡¨ç¤ºé«˜é€ŸåŒ–ï¼‰
            const step = Math.max(1, Math.floor(similarityCurve.length / 1000));
            const labels = [];
            const data = [];
            
            for (let i = 0; i < similarityCurve.length; i += step) {
                labels.push((i * 512 / 22050).toFixed(1));  // ãƒ•ãƒ¬ãƒ¼ãƒ â†’ç§’
                data.push(similarityCurve[i] * 100);
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é¡ä¼¼åº¦ (%)',
                        data: data,
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ™‚é–“ (ç§’)',
                                color: '#fff'
                            },
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'é¡ä¼¼åº¦ (%)',
                                color: '#fff'
                            },
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
